name: Build and Release

on:
  push:
    branches:
      - nightly
      - main
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            name: linux-amd64
            platform: linux
          - os: windows-latest
            name: windows-amd64
            platform: windows
          - os: macos-14
            name: darwin-arm64
            platform: macos
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest
      
      - name: Install dependencies (Linux)
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev
      
      - name: Build
        shell: bash
        run: |
          # Extract version from tag or use branch name
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
            APP_TITLE="HyPrism - Hytale Launcher"
          elif [[ "${GITHUB_REF}" == refs/heads/nightly ]]; then
            # For nightly builds, use commit short SHA
            VERSION="nightly-$(git rev-parse --short HEAD)"
            APP_TITLE="HyPrism Nightly - Hytale Launcher"
          elif [[ "${GITHUB_REF}" == refs/heads/main ]]; then
            VERSION="dev-main"
            APP_TITLE="HyPrism Dev - Hytale Launcher"
          else
            VERSION="dev"
            APP_TITLE="HyPrism - Hytale Launcher"
          fi
          
          echo "Building version: $VERSION"
          echo "App title: $APP_TITLE"
          wails build -clean -tags webkit2_41 -ldflags "-X 'HyPrism/app.AppVersion=$VERSION' -X 'HyPrism/app.AppTitle=$APP_TITLE'"
      
      - name: Create DMG (macOS)
        if: matrix.platform == 'macos'
        run: |
          # Install create-dmg
          brew install create-dmg
          
          # Create a clean directory for DMG contents
          mkdir -p dmg-contents
          
          # Move only the .app bundle to dmg-contents
          mv build/bin/HyPrism.app dmg-contents/
          
          # Create a helper script to remove quarantine from Applications
          cat > dmg-contents/Fix-HyPrism.command << 'HELPER'
          #!/bin/bash
          clear
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘       HyPrism - Fix macOS Security Warning           â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # Check common locations for HyPrism.app
          APP_PATH=""
          if [ -d "/Applications/HyPrism.app" ]; then
              APP_PATH="/Applications/HyPrism.app"
          elif [ -d "$HOME/Applications/HyPrism.app" ]; then
              APP_PATH="$HOME/Applications/HyPrism.app"
          elif [ -d "$(dirname "$0")/HyPrism.app" ]; then
              APP_PATH="$(dirname "$0")/HyPrism.app"
          fi
          
          if [ -z "$APP_PATH" ]; then
              echo "âŒ HyPrism.app not found!"
              echo ""
              echo "Please drag HyPrism.app to your Applications folder first,"
              echo "then run this script again."
              echo ""
              echo "Or run manually in Terminal:"
              echo "  xattr -cr /path/to/HyPrism.app"
              echo ""
              read -p "Press Enter to close..."
              exit 1
          fi
          
          echo "Found HyPrism at: $APP_PATH"
          echo ""
          echo "Removing quarantine attribute..."
          xattr -cr "$APP_PATH"
          
          if [ $? -eq 0 ]; then
              echo ""
              echo "âœ… Success! HyPrism is now ready to use."
              echo ""
              echo "You can now open HyPrism from your Applications folder."
          else
              echo ""
              echo "âŒ Failed to remove quarantine. Try running manually:"
              echo "  sudo xattr -cr \"$APP_PATH\""
          fi
          
          echo ""
          read -p "Press Enter to close..."
          HELPER
          chmod +x dmg-contents/Fix-HyPrism.command
          
          # Create DMG from clean directory
          create-dmg \
            --volname "HyPrism" \
            --window-pos 200 120 \
            --window-size 700 400 \
            --icon-size 100 \
            --icon "HyPrism.app" 175 120 \
            --hide-extension "HyPrism.app" \
            --app-drop-link 525 120 \
            --icon "Fix-HyPrism.command" 350 280 \
            "HyPrism-macOS-arm64.dmg" \
            "dmg-contents"
          
          # Clean build/bin and put only DMG there
          rm -rf build/bin/*
          mv HyPrism-macOS-arm64.dmg build/bin/
      
      - name: Create AppImage (Linux)
        if: matrix.platform == 'linux'
        run: |
          # Use linuxdeploy to properly bundle ALL dependencies including WebKit
          wget -q -O linuxdeploy https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy
          
          # Download appimagetool as fallback
          wget -q -O appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool
          
          # Create AppDir structure
          mkdir -p HyPrism.AppDir/usr/bin
          mkdir -p HyPrism.AppDir/usr/lib
          mkdir -p HyPrism.AppDir/usr/share/applications
          mkdir -p HyPrism.AppDir/usr/share/icons/hicolor/256x256/apps
          mkdir -p HyPrism.AppDir/usr/share/metainfo
          
          # Copy binary
          cp build/bin/HyPrism HyPrism.AppDir/usr/bin/
          chmod +x HyPrism.AppDir/usr/bin/HyPrism
          
          # Copy icon at 512x512 for high resolution displays
          mkdir -p HyPrism.AppDir/usr/share/icons/hicolor/512x512/apps
          convert build/appicon.png -resize 512x512 HyPrism.AppDir/usr/share/icons/hicolor/512x512/apps/hyprism.png || {
            echo "ImageMagick convert failed, trying sips..."
            sips -z 512 512 build/appicon.png --out HyPrism.AppDir/usr/share/icons/hicolor/512x512/apps/hyprism.png
          }
          convert build/appicon.png -resize 512x512 HyPrism.AppDir/hyprism.png || {
            cp HyPrism.AppDir/usr/share/icons/hicolor/512x512/apps/hyprism.png HyPrism.AppDir/hyprism.png
          }
          
          # Create desktop file (must be at root of AppDir)
          cat > HyPrism.AppDir/hyprism.desktop << 'DESKTOP'
          [Desktop Entry]
          Name=HyPrism
          Exec=HyPrism
          Icon=hyprism
          Type=Application
          Categories=Game;
          Terminal=false
          StartupWMClass=HyPrism
          Comment=A modern launcher for Hytale
          DESKTOP
          
          # Copy desktop file to standard location too
          cp HyPrism.AppDir/hyprism.desktop HyPrism.AppDir/usr/share/applications/
          
          # Create AppStream metadata (helps with SteamOS integration)
          cat > HyPrism.AppDir/usr/share/metainfo/hyprism.appdata.xml << 'APPDATA'
          <?xml version="1.0" encoding="UTF-8"?>
          <component type="desktop-application">
            <id>dev.hyprism.HyPrism</id>
            <name>HyPrism</name>
            <summary>A modern launcher for Hytale</summary>
            <metadata_license>MIT</metadata_license>
            <project_license>MIT</project_license>
            <description>
              <p>HyPrism is an open-source, community-driven launcher for Hytale that provides mod management, multiple instances, and more.</p>
            </description>
            <categories>
              <category>Game</category>
            </categories>
          </component>
          APPDATA
          
          # Bundle ALL WebKit2GTK libraries and their dependencies
          echo "Bundling WebKit2GTK and all dependencies..."
          
          # Bundle WebKit helper processes (CRITICAL - these are executables, not just libraries!)
          echo "Bundling WebKit helper processes..."
          mkdir -p HyPrism.AppDir/usr/lib/x86_64-linux-gnu/webkit2gtk-4.1
          WEBKIT_PROCESSES="
            /usr/lib/x86_64-linux-gnu/webkit2gtk-4.1/WebKitNetworkProcess
            /usr/lib/x86_64-linux-gnu/webkit2gtk-4.1/WebKitWebProcess
          "
          for proc in $WEBKIT_PROCESSES; do
            if [ -f "$proc" ]; then
              cp "$proc" HyPrism.AppDir/usr/lib/x86_64-linux-gnu/webkit2gtk-4.1/
              chmod +x HyPrism.AppDir/usr/lib/x86_64-linux-gnu/webkit2gtk-4.1/$(basename "$proc")
              echo "Bundled: $(basename $proc)"
            fi
          done
          
          # Find and copy all required libraries with their dependencies
          # Use ldd to find all dependencies of the main webkit libraries
          # Use webkit2gtk-4.1 libraries (modern, supported by all current distros)
          WEBKIT_LIBS="libwebkit2gtk-4.1.so.0 libjavascriptcoregtk-4.1.so.0"
          for lib in $WEBKIT_LIBS; do
            LIBPATH=$(find /usr/lib -name "$lib" 2>/dev/null | head -1)
            if [ -n "$LIBPATH" ]; then
              echo "Found $lib at $LIBPATH"
              cp -L "$LIBPATH" HyPrism.AppDir/usr/lib/ 2>/dev/null || true
            fi
          done
          
          # Bundle ALL transitive dependencies by using ldd recursively
          echo "Bundling all transitive dependencies..."
          
          # Function to recursively copy all dependencies
          copy_deps() {
            local lib="$1"
            if [ ! -f "$lib" ]; then
              return
            fi
            
            # Get all dependencies
            ldd "$lib" 2>/dev/null | grep "=> /" | awk '{print $3}' | while read dep; do
              if [ -f "$dep" ]; then
                local basename=$(basename "$dep")
                if [ ! -f "HyPrism.AppDir/usr/lib/$basename" ]; then
                  echo "Bundling: $basename"
                  cp -L "$dep" HyPrism.AppDir/usr/lib/ 2>/dev/null || true
                  # Recursively copy its dependencies
                  copy_deps "$dep"
                fi
              fi
            done
          }
          
          # First, manually bundle the main WebKit libs and common missing ones
          CRITICAL_LIBS="
            libwoff2dec.so.1.0.2
            libwoff2common.so.1.0.2
            libbrotlidec.so.1
            libbrotlicommon.so.1
            libharfbuzz-icu.so.0
            libharfbuzz.so.0
            libicui18n.so.*
            libicuuc.so.*
            libicudata.so.*
            libenchant-2.so.*
            libhyphen.so.*
            libsoup-3.0.so.*
            libsecret-1.so.*
            libnotify.so.*
            libmanette-0.2.so.*
            libwpe-1.0.so.*
            libWPEBackend-fdo-1.0.so.*
            libgraphite2.so.*
            libjpeg.so.*
            libpng16.so.*
            libwebp.so.*
            libopenjp2.so.*
            liblcms2.so.*
          "
          
          for pattern in $CRITICAL_LIBS; do
            for libpath in /usr/lib/x86_64-linux-gnu/$pattern /usr/lib/$pattern; do
              if [ -f "$libpath" ]; then
                cp -L "$libpath" HyPrism.AppDir/usr/lib/ 2>/dev/null || true
                echo "Bundled: $(basename $libpath)"
                # Copy its dependencies too
                copy_deps "$libpath"
              fi
            done
          done
          
          # Copy dependencies of the main webkit libraries
          for lib in HyPrism.AppDir/usr/lib/libwebkit2gtk-4.1.so.* HyPrism.AppDir/usr/lib/libjavascriptcoregtk-4.1.so.*; do
            if [ -f "$lib" ]; then
              copy_deps "$lib"
            fi
          done
          
          # CRITICAL: Remove glibc from bundle - bundling libc causes GLIBC_ABI_DT_RELR errors
          # when system binaries (like grep) try to load our bundled older glibc
          echo "Removing glibc from bundle (must use system glibc)..."
          rm -f HyPrism.AppDir/usr/lib/libc.so* 2>/dev/null || true
          rm -f HyPrism.AppDir/usr/lib/libpthread.so* 2>/dev/null || true
          rm -f HyPrism.AppDir/usr/lib/libdl.so* 2>/dev/null || true
          rm -f HyPrism.AppDir/usr/lib/libm.so* 2>/dev/null || true
          rm -f HyPrism.AppDir/usr/lib/librt.so* 2>/dev/null || true
          rm -f HyPrism.AppDir/usr/lib/ld-linux*.so* 2>/dev/null || true
          
          # Create comprehensive library list
          echo "Checking for missing dependencies..."
          ldd HyPrism.AppDir/usr/bin/HyPrism 2>/dev/null | grep "not found" || echo "No missing deps for binary"
          
          # Create AppRun with auto-download of missing libraries
          cat > HyPrism.AppDir/AppRun << 'APPRUN'
          #!/bin/bash
          # AppRun script for HyPrism with automatic library download
          
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          
          # Local library cache directory
          LIBCACHE="${HOME}/.local/lib/hyprism"
          mkdir -p "$LIBCACHE"
          
          # Library download URL (HyPrism releases - we bundle webkit libs there)
          LIB_URL="https://github.com/yyyumeniku/HyPrism/releases/latest/download"
          
          # Function to check if a library exists anywhere (webkit2gtk-4.1)
          check_lib() {
            ldconfig -p 2>/dev/null | grep -q "$1" || \
            [ -f "${HERE}/usr/lib/$1" ] || \
            [ -f "${LIBCACHE}/$1" ] || \
            [ -f "/usr/lib/$1" ] || \
            [ -f "/usr/lib/x86_64-linux-gnu/$1" ]
          }
          
          # Function to download libraries if missing
          download_webkit_libs() {
            echo "HyPrism: Checking for WebKit2GTK libraries..."
            
            # Check if we need to download (using webkit2gtk-4.1)
            if ! check_lib "libwebkit2gtk-4.1.so.0"; then
              echo "HyPrism: WebKit2GTK 4.1 not found. Downloading libraries..."
              echo "This is a one-time setup that may take a minute."
              echo ""
              
              # Try to download from multiple sources
              DOWNLOAD_SUCCESS=false
              
              # Source 1: Pre-built library bundle from HyPrism releases
              BUNDLE_URL="https://github.com/yyyumeniku/HyPrism/releases/latest/download/webkit2gtk-libs-x86_64.tar.gz"
              
              if command -v curl &> /dev/null; then
                if curl -fsSL "$BUNDLE_URL" -o "/tmp/webkit-libs.tar.gz" 2>/dev/null; then
                  tar -xzf "/tmp/webkit-libs.tar.gz" -C "$LIBCACHE" 2>/dev/null && DOWNLOAD_SUCCESS=true
                  rm -f "/tmp/webkit-libs.tar.gz"
                fi
              elif command -v wget &> /dev/null; then
                if wget -q "$BUNDLE_URL" -O "/tmp/webkit-libs.tar.gz" 2>/dev/null; then
                  tar -xzf "/tmp/webkit-libs.tar.gz" -C "$LIBCACHE" 2>/dev/null && DOWNLOAD_SUCCESS=true
                  rm -f "/tmp/webkit-libs.tar.gz"
                fi
              fi
              
              if [ "$DOWNLOAD_SUCCESS" = true ]; then
                echo "HyPrism: Libraries downloaded successfully!"
              else
                echo ""
                echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                echo "â•‘  HyPrism requires WebKit2GTK 4.1 which is not installed.     â•‘"
                echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                echo "â•‘  Please install it manually:                                  â•‘"
                echo "â•‘                                                               â•‘"
                echo "â•‘  Arch Linux:  sudo pacman -S webkit2gtk-4.1                  â•‘"
                echo "â•‘  Ubuntu:      sudo apt install libwebkit2gtk-4.1-0           â•‘"
                echo "â•‘  Fedora:      sudo dnf install webkit2gtk4.1                 â•‘"
                echo "â•‘                                                               â•‘"
                echo "â•‘  Or use the Flatpak version which bundles all dependencies.  â•‘"
                echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo ""
                
                # Show a GUI dialog if zenity is available
                if command -v zenity &> /dev/null; then
                  zenity --error --title="HyPrism - Missing Dependencies" \
                    --text="WebKit2GTK 4.1 is required but not installed.\n\nPlease install it:\nâ€¢ Arch: sudo pacman -S webkit2gtk-4.1\nâ€¢ Ubuntu: sudo apt install libwebkit2gtk-4.1-0\n\nOr use the Flatpak version." \
                    --width=400 2>/dev/null
                elif command -v kdialog &> /dev/null; then
                  kdialog --error "WebKit2GTK 4.1 is required but not installed.\n\nPlease install it:\nâ€¢ Arch: sudo pacman -S webkit2gtk-4.1\nâ€¢ Ubuntu: sudo apt install libwebkit2gtk-4.1-0\n\nOr use the Flatpak version." \
                    --title "HyPrism - Missing Dependencies" 2>/dev/null
                fi
                
                exit 1
              fi
            fi
          }
          
          # Check and download libraries if needed
          download_webkit_libs
          
          # Add library paths (bundled + cached + system)
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${LIBCACHE}:${LD_LIBRARY_PATH}"
          
          # Add our bundled binaries to path
          export PATH="${HERE}/usr/bin:${PATH}"
          
          # Handle XDG directories for proper file access
          export XDG_DATA_DIRS="${HERE}/usr/share:${XDG_DATA_DIRS:-/usr/local/share:/usr/share}"
          
          # CRITICAL: Tell WebKit where to find helper processes
          # Check bundled processes first, then fall back to system
          if [ -d "${HERE}/usr/lib/x86_64-linux-gnu/webkit2gtk-4.1" ] && [ -f "${HERE}/usr/lib/x86_64-linux-gnu/webkit2gtk-4.1/WebKitNetworkProcess" ]; then
            export WEBKIT_EXEC_PATH="${HERE}/usr/lib/x86_64-linux-gnu/webkit2gtk-4.1"
            export WEBKIT_PROCESS_CMD_PREFIX="${HERE}/usr/lib/x86_64-linux-gnu/webkit2gtk-4.1"
          elif [ -d "/usr/lib/x86_64-linux-gnu/webkit2gtk-4.1" ]; then
            export WEBKIT_EXEC_PATH="/usr/lib/x86_64-linux-gnu/webkit2gtk-4.1"
            export WEBKIT_PROCESS_CMD_PREFIX="/usr/lib/x86_64-linux-gnu/webkit2gtk-4.1"
          elif [ -d "/usr/libexec/webkit2gtk-4.1" ]; then
            # Fedora/RHEL location
            export WEBKIT_EXEC_PATH="/usr/libexec/webkit2gtk-4.1"
            export WEBKIT_PROCESS_CMD_PREFIX="/usr/libexec/webkit2gtk-4.1"
          fi
          
          # WebKit environment variables for better compatibility
          export WEBKIT_DISABLE_COMPOSITING_MODE="${WEBKIT_DISABLE_COMPOSITING_MODE:-0}"
          export WEBKIT_DISABLE_DMABUF_RENDERER=1
          
          # Final check: verify the binary can load before launching
          if ! ldd "${HERE}/usr/bin/HyPrism" 2>&1 | grep -q "not found"; then
            # All good, launch the application
            cd "${HERE}/usr/bin"
            exec ./HyPrism "$@"
          else
            # Still missing dependencies - show which ones
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  ERROR: Still missing required libraries                     â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "Missing libraries:"
            ldd "${HERE}/usr/bin/HyPrism" 2>&1 | grep "not found"
            echo ""
            echo "Please install webkit2gtk-4.1 from your package manager"
            echo "or use the Flatpak version."
            echo ""
            
            if command -v zenity &> /dev/null; then
              MISSING=$(ldd "${HERE}/usr/bin/HyPrism" 2>&1 | grep "not found" | cut -d' ' -f1 | tr '\n' ' ')
              zenity --error --title="HyPrism - Missing Libraries" \
                --text="Still missing required libraries:\n\n$MISSING\n\nPlease use the Flatpak version or install webkit2gtk-4.1." \
                --width=400 2>/dev/null
            fi
            
            exit 1
          fi
          APPRUN
          chmod +x HyPrism.AppDir/AppRun
          
          # List bundled libraries for debugging
          echo "Bundled libraries:"
          ls -la HyPrism.AppDir/usr/lib/ || true
          
          # Create a standalone webkit libs bundle for download
          echo "Creating webkit library bundle for auto-download..."
          cd HyPrism.AppDir/usr/lib
          tar -czvf ../../../webkit2gtk-libs-x86_64.tar.gz *.so* 2>/dev/null || echo "No libs to bundle"
          cd ../../..
          
          # Build AppImage with ARCH set and extract-and-run for compatibility
          ARCH=x86_64 ./appimagetool --appimage-extract-and-run HyPrism.AppDir HyPrism-x86_64.AppImage
          
          # Save the binary before cleaning build/bin
          cp HyPrism.AppDir/usr/bin/HyPrism /tmp/HyPrism-binary
          
          # Replace binary with AppImage
          rm -rf build/bin/*
          mv HyPrism-x86_64.AppImage build/bin/
          
          # Move webkit libs bundle to build/bin for release
          mv webkit2gtk-libs-x86_64.tar.gz build/bin/ 2>/dev/null || true
          
          # Also create a tar.gz for systems where AppImage doesn't work
          cd HyPrism.AppDir/usr/bin
          tar -czvf ../../../HyPrism-linux-x86_64.tar.gz HyPrism
          cd ../../..
          mv HyPrism-linux-x86_64.tar.gz build/bin/

      - name: Build Flatpak (Linux)
        if: matrix.platform == 'linux'
        run: |
          set -ex
          
          echo "=========================================="
          echo "Starting Flatpak build process"
          echo "=========================================="
          
          # Install Flatpak and flatpak-builder
          echo "Installing Flatpak..."
          sudo apt-get update -qq
          sudo apt-get install -y flatpak flatpak-builder
          
          # Add Flathub remote
          echo "Adding Flathub remote..."
          sudo flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
          
          # Install required runtime with retries
          echo "Installing GNOME Platform 46 (has webkit2gtk-4.1)..."
          for i in 1 2 3; do
            if sudo flatpak install -y --noninteractive flathub org.gnome.Platform//46 org.gnome.Sdk//46; then
              echo "Runtime installed successfully"
              break
            else
              echo "Attempt $i failed, retrying..."
              sleep 5
            fi
          done
          
          # Verify runtime is installed
          echo "Verifying runtime installation..."
          flatpak list | grep org.gnome.Platform
          flatpak list | grep org.gnome.Sdk
          
          # Prepare all files in the flatpak directory
          echo "Preparing files..."
          cp /tmp/HyPrism-binary flatpak/HyPrism
          chmod +x flatpak/HyPrism
          
          # Resize icon to 512x512 for Flatpak (max allowed size)
          echo "Resizing icon to 512x512..."
          convert build/appicon.png -resize 512x512 flatpak/dev.hyprism.HyPrism.png || {
            echo "ImageMagick not found, trying with sips..."
            sips -z 512 512 build/appicon.png --out flatpak/dev.hyprism.HyPrism.png
          }
          
          # Verify all required files exist
          echo "Verifying files..."
          ls -lh flatpak/HyPrism
          ls -lh flatpak/dev.hyprism.HyPrism.png
          ls -lh flatpak/dev.hyprism.HyPrism.desktop
          ls -lh flatpak/dev.hyprism.HyPrism.metainfo.xml
          ls -lh flatpak/dev.hyprism.HyPrism.json
          
          # Test that binary is executable
          file flatpak/HyPrism
          
          # Build the Flatpak
          echo "=========================================="
          echo "Building Flatpak bundle..."
          echo "=========================================="
          cd flatpak
          
          flatpak-builder \
            --force-clean \
            --repo=repo \
            --install-deps-from=flathub \
            builddir \
            dev.hyprism.HyPrism.json
          
          echo "Creating Flatpak bundle..."
          flatpak build-bundle repo HyPrism.flatpak dev.hyprism.HyPrism
          
          # Verify bundle was created and has content
          if [ ! -f HyPrism.flatpak ]; then
            echo "ERROR: Flatpak bundle was not created!"
            exit 1
          fi
          
          BUNDLE_SIZE=$(stat -c%s HyPrism.flatpak 2>/dev/null || stat -f%z HyPrism.flatpak)
          echo "Bundle created successfully: $BUNDLE_SIZE bytes"
          
          if [ "$BUNDLE_SIZE" -lt 1000000 ]; then
            echo "ERROR: Bundle size too small, something went wrong!"
            exit 1
          fi
          
          mv HyPrism.flatpak ../build/bin/
          
          # Verify it was moved
          ls -lh ../build/bin/HyPrism.flatpak
          
          # Clean up
          rm -f HyPrism dev.hyprism.HyPrism.png
          rm -rf repo builddir .flatpak-builder
          
          echo "=========================================="
          echo "Flatpak build completed successfully!"
          echo "=========================================="

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: HyPrism-${{ matrix.name }}
          path: build/bin/*
          
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/nightly'
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Flatten artifacts
        run: |
          # Move all files from subdirectories to artifacts root
          find artifacts -type f -mindepth 2 -exec mv {} artifacts/ \;
          # Remove empty subdirectories
          find artifacts -type d -empty -delete
      
      - name: Determine version and release type
        id: version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
            IS_PRERELEASE="false"
            RELEASE_NAME="v$VERSION"
            TAG_NAME="v$VERSION"
          elif [[ "${GITHUB_REF}" == refs/heads/nightly ]]; then
            VERSION="nightly-$(git rev-parse --short HEAD)"
            IS_PRERELEASE="true"
            RELEASE_NAME="Nightly Build $(date +'%Y-%m-%d')"
            TAG_NAME="nightly"
          else
            VERSION="dev"
            IS_PRERELEASE="true"
            RELEASE_NAME="Development Build"
            TAG_NAME="dev"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
      
      - name: Create version.json for auto-updater
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG_NAME="${{ steps.version.outputs.tag_name }}"
          cat > artifacts/version.json << EOF
          {
            "version": "$VERSION",
            "linux": {
              "amd64": {
                "launcher": {
                  "url": "https://github.com/yyyumeniku/HyPrism/releases/download/$TAG_NAME/HyPrism-x86_64.AppImage",
                  "sha256": ""
                },
                "tarball": {
                  "url": "https://github.com/yyyumeniku/HyPrism/releases/download/$TAG_NAME/HyPrism-linux-x86_64.tar.gz",
                  "sha256": ""
                },
                "flatpak": {
                  "url": "https://github.com/yyyumeniku/HyPrism/releases/download/$TAG_NAME/HyPrism.flatpak",
                  "sha256": ""
                }
              }
            },
            "windows": {
              "amd64": {
                "launcher": {
                  "url": "https://github.com/yyyumeniku/HyPrism/releases/download/$TAG_NAME/HyPrism.exe",
                  "sha256": ""
                }
              }
            },
            "darwin": {
              "amd64": {
                "launcher": {
                  "url": "",
                  "sha256": ""
                }
              },
              "arm64": {
                "launcher": {
                  "url": "https://github.com/yyyumeniku/HyPrism/releases/download/$TAG_NAME/HyPrism-macOS-arm64.dmg",
                  "sha256": ""
                }
              }
            }
          }
          EOF
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*
          name: ${{ steps.version.outputs.release_name }}
          tag_name: ${{ steps.version.outputs.tag_name }}
          prerelease: ${{ steps.version.outputs.is_prerelease }}
          body: |
            ## HyPrism ${{ steps.version.outputs.release_name }}
            
            ${{ steps.version.outputs.is_prerelease == 'true' && 'âš ï¸ This is a pre-release nightly build for testing.' || 'ðŸŽ‰ Stable release' }}
            
            ### Installation
            - **Windows**: Download `HyPrism.exe`
            - **macOS**: Download `HyPrism-macOS-arm64.dmg`
            - **Linux**: Download `HyPrism.flatpak` (recommended) or `HyPrism-x86_64.AppImage`
            
            ### Changes
            See commit history for details.
