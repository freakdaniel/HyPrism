name: Build HyPrism

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Override version tag - Version will be inferred from app.manifest or git tag if not provided'
        required: false
        default: ''
      do_release:
        description: 'Set to true to create the GitHub Release'
        required: false
        default: false
        type: boolean
      prerelease:
        description: 'Set to true to mark the GitHub Release as prerelease'
        required: false
        default: true
        type: boolean

env:
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '20'

jobs:
  generate-linux-bundle:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Determine version for Linux packages
        run: |
          set -euo pipefail
          if [ ! -f app.manifest ]; then
            echo "ERROR: app.manifest not found"
            exit 1
          fi
          RAW=$(grep -oP 'assemblyIdentity\s+[^>]*version="\K[^"]+' app.manifest || true)
          if [ -z "$RAW" ]; then
            echo "ERROR: could not parse version from app.manifest"
            exit 1
          fi
          IFS=. read -r MAJOR MINOR PATCH REST <<<"$RAW"
          PATCH=${PATCH:-0}
          VERSION="$MAJOR.$MINOR.$PATCH"
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "::warning::Version overridden by workflow input (discouraged). Prefer updating app.manifest to keep it authoritative."
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Generate Linux bundle via script
        run: |
          ./scripts/build-linux.sh --auto-install-deps --only-bundle

      - name: Normalize Linux tarballs
        run: |
          set -euo pipefail
          if [ -f artifacts/HyPrism-linux-x64-portable.tar.gz ] && [ ! -f artifacts/HyPrism-linux-x64.tar.gz ]; then
            mv artifacts/HyPrism-linux-x64-portable.tar.gz artifacts/HyPrism-linux-x64.tar.gz
          fi
          if [ -f artifacts/HyPrism-linux-arm64-portable.tar.gz ] && [ ! -f artifacts/HyPrism-linux-arm64.tar.gz ]; then
            mv artifacts/HyPrism-linux-arm64-portable.tar.gz artifacts/HyPrism-linux-arm64.tar.gz
          fi
          ls -la artifacts | sed -n '1,200p'

      - name: Upload Linux bundle artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-bundle
          path: |
            packaging/flatpak/bundle/**
            artifacts/linux-x64/portable/**
            artifacts/HyPrism-linux-x64.tar.gz
            artifacts/HyPrism-linux-arm64.tar.gz

  package-appimage:
    needs: generate-linux-bundle
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux bundle
        uses: actions/download-artifact@v4
        with:
          name: linux-bundle
          path: .

      - name: Install AppImage tool (if missing)
        run: |
          if ! command -v appimagetool >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y libfuse2 || true
            curl -fsSL -o /tmp/appimagetool "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
            chmod +x /tmp/appimagetool
            sudo mv /tmp/appimagetool /usr/local/bin/appimagetool
          fi

      - name: Build AppImage via script
        run: |
          SKIP_BUILD=1 ./scripts/build-linux.sh --auto-install-deps --only-appimage

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: appimage
          path: artifacts/HyPrism-linux-x64.AppImage

  package-flatpak:
    needs: generate-linux-bundle
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux bundle
        uses: actions/download-artifact@v4
        with:
          name: linux-bundle
          path: .

      - name: Build Flatpak via script
        run: |
          SKIP_BUILD=1 ./scripts/build-linux.sh --auto-install-deps --only-flatpak

      - name: Upload Flatpak artifact
        uses: actions/upload-artifact@v4
        with:
          name: flatpak
          path: artifacts/HyPrism-linux-x64.flatpak
          if-no-files-found: warn

      - name: Upload Flatpak repo artifact
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-repo
          path: artifacts/flatpak-repo/**
          if-no-files-found: warn

  publish-flatpak-remote:
    needs: package-flatpak
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}
    steps:
      - name: Download Flatpak repo artifact
        uses: actions/download-artifact@v4
        with:
          name: flatpak-repo
          path: flatpak-repo

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: flatpak-repo

      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4

  package-deb-rpm:
    needs: generate-linux-bundle
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux bundle
        uses: actions/download-artifact@v4
        with:
          name: linux-bundle
          path: .

      - name: Determine version for Linux packages
        run: |
          set -euo pipefail
          if [ ! -f app.manifest ]; then
            echo "ERROR: app.manifest not found"
            exit 1
          fi
          RAW=$(grep -oP 'assemblyIdentity\s+[^>]*version="\K[^"]+' app.manifest || true)
          if [ -z "$RAW" ]; then
            echo "ERROR: could not parse version from app.manifest"
            exit 1
          fi
          IFS=. read -r MAJOR MINOR PATCH REST <<<"$RAW"
          PATCH=${PATCH:-0}
          VERSION="$MAJOR.$MINOR.$PATCH"
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "::warning::Version overridden by workflow input (discouraged). Prefer updating app.manifest to keep it authoritative."
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Build deb/rpm via script
        run: |
          SKIP_BUILD=1 ./scripts/build-linux.sh --auto-install-deps --only-deb-rpm

      - name: Upload deb/rpm artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            artifacts/HyPrism-linux-x64.deb
            artifacts/HyPrism-linux-x64.rpm

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Build Windows x64
        run: |
          dotnet restore
          dotnet publish ./HyPrism.csproj -c Release -r win-x64 --self-contained true `
            /p:PublishSingleFile=true /p:PublishReadyToRun=true `
            /p:IncludeNativeLibrariesForSelfExtract=true `
            /p:IncludeAllContentForSelfExtract=true `
            /p:OutputType=WinExe /p:ApplicationManifest=app.manifest `
            /p:ApplicationIcon=packaging/windows/HyPrism.ico `
            -o artifacts/win-x64

      - name: Rename Windows exe for release
        run: |
          # Rename to include version info for direct download
          Copy-Item artifacts/win-x64/HyPrism.exe artifacts/HyPrism-windows-x64.exe

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-builds
          path: artifacts/HyPrism-windows-x64.exe

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Build macOS arm64
        run: |
          dotnet publish ./HyPrism.csproj -c Release -r osx-arm64 --self-contained true \
            -o artifacts/osx-arm64

      - name: Create macOS app bundle (arm64 only)
        run: |
          set -e
          
          mkdir -p "artifacts/HyPrism.app/Contents/MacOS"
          mkdir -p "artifacts/HyPrism.app/Contents/Resources"
          
          if [ ! -f "artifacts/osx-arm64/HyPrism" ]; then
            echo "ERROR: HyPrism binary not found!"
            ls -la artifacts/osx-arm64/ || true
            exit 1
          fi
          
          # Copy ALL files from publish output to MacOS folder (includes all .NET runtime files)
          cp -R artifacts/osx-arm64/* "artifacts/HyPrism.app/Contents/MacOS/"
          
          # Move wwwroot and jre.json to Resources (app expects them in Resources or next to exe)
          if [ -d "artifacts/HyPrism.app/Contents/MacOS/wwwroot" ]; then
            cp -R "artifacts/HyPrism.app/Contents/MacOS/wwwroot" "artifacts/HyPrism.app/Contents/Resources/"
          fi
          if [ -f "artifacts/HyPrism.app/Contents/MacOS/jre.json" ]; then
            cp "artifacts/HyPrism.app/Contents/MacOS/jre.json" "artifacts/HyPrism.app/Contents/Resources/"
          fi
          
          cp packaging/macos/Info.plist "artifacts/HyPrism.app/Contents/"
          cp packaging/macos/HyPrism.icns "artifacts/HyPrism.app/Contents/Resources/"
          chmod +x "artifacts/HyPrism.app/Contents/MacOS/HyPrism"
          echo "APPL????" > "artifacts/HyPrism.app/Contents/PkgInfo"

      - name: Create DMG (arm64 only)
        run: |
          mkdir -p dmg
          cp -R "artifacts/HyPrism.app" "dmg/HyPrism.app"
          ln -s /Applications dmg/Applications
          hdiutil create -volname "HyPrism" -srcfolder dmg -ov -format UDZO artifacts/HyPrism-macos-arm64.dmg

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-builds
          path: artifacts/HyPrism-macos-arm64.dmg

  release:
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.do_release == 'true' && always() }}
    needs: [package-appimage, package-flatpak, package-deb-rpm, build-windows, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Check build results (fail only if all failed)
        run: |
          set -euo pipefail
          RESULTS=(
            "${{ needs.package-appimage.result }}"
            "${{ needs.package-flatpak.result }}"
            "${{ needs.package-deb-rpm.result }}"
            "${{ needs.build-windows.result }}"
            "${{ needs.build-macos.result }}"
          )

          HAS_SUCCESS=false
          for r in "${RESULTS[@]}"; do
            if [ "$r" = "success" ]; then
              HAS_SUCCESS=true
              break
            fi
          done

          if [ "$HAS_SUCCESS" = "false" ]; then
            echo "ERROR: All builds failed or were canceled. Release blocked."
            exit 1
          fi

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: release-assets
          merge-multiple: true

      - name: Ensure release-assets exists
        run: |
          mkdir -p release-assets

      - name: List release assets
        run: ls -la release-assets/ || true

      - name: Determine version from app.manifest (default), optional input override, and tag consistency
        id: determine_version
        run: |
          set -euo pipefail

          # --- Default: derive version from app.manifest (source of truth) ---
          if [ ! -f app.manifest ]; then
            echo "ERROR: app.manifest not found"
            exit 1
          fi
          RAW=$(grep -oP 'assemblyIdentity\s+[^>]*version="\K[^"]+' app.manifest || true)
          if [ -z "$RAW" ]; then
            echo "ERROR: could not parse version from app.manifest"
            exit 1
          fi
          IFS=. read -r MAJOR MINOR PATCH REST <<<"$RAW"
          PATCH=${PATCH:-0}
          VERSION="$MAJOR.$MINOR.$PATCH"

          # --- Optional override by workflow input (discouraged) ---
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "::warning::Version overridden by workflow input (discouraged). Prefer updating app.manifest to keep it authoritative."
            VERSION="${{ github.event.inputs.version }}"
          fi

          # --- Tag consistency: only enforce when run is for a tag (refs/tags/*) ---
          if [[ "${GITHUB_REF:-}" == refs/tags/* ]]; then
            TAG_NAME="${GITHUB_REF#refs/tags/}"
            if [ "${TAG_NAME}" != "v$VERSION" ]; then
              echo "ERROR: Tag '${TAG_NAME}' does not match version '${VERSION}' (derived from app.manifest or override)."
              echo "Please tag as v$VERSION or provide the correct version via workflow input."
              exit 1
            fi
          else
            TAG_NAME="v$VERSION"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Create version.json for auto-updater
        run: |
          VERSION="${{ steps.determine_version.outputs.version }}"
          TAG_NAME="v${{ steps.determine_version.outputs.version }}"

          cat > release-assets/version.json << EOF
          {
            "version": "$VERSION",
            "linux": {
              "amd64": {
                "launcher": {
                  "url": "https://github.com/$GITHUB_REPOSITORY/releases/download/$TAG_NAME/HyPrism-linux-x64.AppImage",
                  "sha256": ""
                },
                "tarball": {
                  "url": "https://github.com/$GITHUB_REPOSITORY/releases/download/$TAG_NAME/HyPrism-linux-x64.tar.gz",
                  "sha256": ""
                }
              },
              "arm64": {
                "launcher": {
                  "url": "https://github.com/$GITHUB_REPOSITORY/releases/download/$TAG_NAME/HyPrism-linux-arm64.tar.gz",
                  "sha256": ""
                },
                "tarball": {
                  "url": "https://github.com/$GITHUB_REPOSITORY/releases/download/$TAG_NAME/HyPrism-linux-arm64.tar.gz",
                  "sha256": ""
                }
              }
            },
            "windows": {
              "amd64": {
                "launcher": {
                  "url": "https://github.com/$GITHUB_REPOSITORY/releases/download/$TAG_NAME/HyPrism-windows-x64.exe",
                  "sha256": ""
                }
              }
            },
            "darwin": {
              "arm64": {
                "launcher": {
                  "url": "https://github.com/$GITHUB_REPOSITORY/releases/download/$TAG_NAME/HyPrism-macos-arm64.dmg",
                  "sha256": ""
                }
              }
            }
          }
          EOF

      - name: Validate release tag
        run: |
          set -euo pipefail
          TAG_NAME="v${{ steps.determine_version.outputs.version }}"
          if [ -z "$TAG_NAME" ] || [ "$TAG_NAME" = "main" ]; then
            echo "ERROR: Invalid release tag: '$TAG_NAME'" >&2
            exit 1
          fi

      - name: Detect missing release artifacts
        id: detect_missing
        run: |
          set -euo pipefail
          EXPECTED=(
            "HyPrism-linux-x64.deb"
            "HyPrism-linux-x64.rpm"
            "HyPrism-linux-x64.AppImage"
            "HyPrism.flatpak"
            "HyPrism-windows-x64.exe"
            "HyPrism-macos-arm64.dmg"
          )

          MISSING=()
          for f in "${EXPECTED[@]}"; do
            if [ ! -f "release-assets/$f" ]; then
              MISSING+=("$f")
            fi
          done

          if [ ${#MISSING[@]} -gt 0 ]; then
            {
              echo "warning_block<<EOF"
              echo "### ⚠️ Build warnings"
              echo "The following builds were not published because they failed:"
              for m in "${MISSING[@]}"; do
                echo "- $m"
              done
              echo ""
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          else
            echo "warning_block=" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ steps.determine_version.outputs.version }}
          name: HyPrism v${{ steps.determine_version.outputs.version }}
          body: |
            ## HyPrism v${{ steps.determine_version.outputs.version }}

            ${{ steps.detect_missing.outputs.warning_block }}
            
            ### Downloads
            
            **Windows**
            - `HyPrism-windows-x64.zip` - Windows 64-bit
            
            **macOS**
            - `HyPrism-macos-arm64.dmg` - macOS Apple Silicon
            
            **Linux - Modern (Ubuntu 22.04+, Debian 11+, Fedora 36+)**
            - `HyPrism-linux-x64.tar.gz` - Linux 64-bit portable (webkit2gtk-4.1)
            - `HyPrism-linux-arm64.tar.gz` - Linux ARM64 portable (webkit2gtk-4.1)
            - `HyPrism-linux-x64.deb` - Debian/Ubuntu package (webkit2gtk-4.1)
            - `HyPrism-linux-x64.rpm` - Fedora/RHEL package (webkit2gtk-4.1)
            - `HyPrism-linux-x64.AppImage` - Universal Linux AppImage (webkit2gtk-4.1)
            
            ### Important Notes
            
            **Older Linux systems**: on some older distros only the Flatpak may work.
            
            ### Changes
            - Updated to support webkit2gtk-4.1
          draft: false
          prerelease: ${{ github.event.inputs.prerelease }}
          artifacts: release-assets/*
          allowUpdates: true
          replacesArtifacts: true
