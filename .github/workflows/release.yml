name: Build HyPrism

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Override version tag - Version will be inferred from app.manifest or git tag if not provided'
        required: false
        default: ''
      do_release:
        description: 'Set to true to create the GitHub Release'
        required: false
        default: false
        type: boolean

env:
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '20'

jobs:
  build-linux-publish:
    if: false
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Build Linux x64
        run: |
          dotnet restore
          dotnet publish ./HyPrism.csproj -c Release -r linux-x64 --self-contained true \
            /p:PublishSingleFile=true /p:PublishReadyToRun=true \
            /p:IncludeNativeLibrariesForSelfExtract=true \
            /p:IncludeAllContentForSelfExtract=true \
            -o artifacts/linux-x64

      - name: Build Linux arm64
        run: |
          dotnet publish ./HyPrism.csproj -c Release -r linux-arm64 --self-contained true \
            /p:PublishSingleFile=true /p:PublishReadyToRun=true \
            /p:IncludeNativeLibrariesForSelfExtract=true \
            /p:IncludeAllContentForSelfExtract=true \
            -o artifacts/linux-arm64

      - name: Create tar.gz archives
        run: |
          cd artifacts/linux-x64 && tar -czf ../HyPrism-linux-x64.tar.gz . && cd ../..
          cd artifacts/linux-arm64 && tar -czf ../HyPrism-linux-arm64.tar.gz . && cd ../..

      - name: Upload linux publish artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-publish
          path: |
            artifacts/linux-x64/**
            artifacts/linux-arm64/**
            artifacts/HyPrism-linux-x64.tar.gz
            artifacts/HyPrism-linux-arm64.tar.gz

  build-frontend:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build
          # Vite is configured to write to ../wwwroot (see frontend/vite.config.ts)
          # Verify output exists and fail the job if not
          if [ -d "../wwwroot" ] && [ "$(ls -A ../wwwroot | wc -c)" -gt 0 ]; then
            echo "Frontend build succeeded and ../wwwroot is populated"
            ls -la ../wwwroot | sed -n '1,200p'
          else
            echo "ERROR: Frontend build did not produce expected output in ../wwwroot"
            ls -la .. | sed -n '1,200p'
            exit 1
          fi

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: wwwroot/**

  publish-backend:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore & Publish backend
        run: |
          dotnet restore
          dotnet publish ./HyPrism.csproj -c Release -r linux-x64 --self-contained true \
            /p:PublishSingleFile=true /p:PublishReadyToRun=true \
            /p:IncludeNativeLibrariesForSelfExtract=true /p:IncludeAllContentForSelfExtract=true \
            -o artifacts/linux-x64
          dotnet publish ./HyPrism.csproj -c Release -r linux-arm64 --self-contained true \
            /p:PublishSingleFile=true /p:PublishReadyToRun=true \
            /p:IncludeNativeLibrariesForSelfExtract=true /p:IncludeAllContentForSelfExtract=true \
            -o artifacts/linux-arm64

          # Ensure the published single-file binaries are executable so downstream packaging works
          chmod +x artifacts/linux-x64/HyPrism || true
          chmod +x artifacts/linux-arm64/HyPrism || true
          echo "Post-publish listing (linux-x64):"; ls -la artifacts/linux-x64 | sed -n '1,200p' || true

      - name: Upload backend publish
        uses: actions/upload-artifact@v4
        with:
          name: backend-publish
          path: |
            artifacts/linux-x64/**
            artifacts/linux-arm64/**

  assemble-linux-publish:
    needs: [build-frontend, publish-backend]
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Download frontend
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend-dist

      - name: Download backend publish
        uses: actions/download-artifact@v4
        with:
          name: backend-publish
          path: artifacts

      - name: Verify downloaded backend publish ⚠️
        run: |
          if [ ! -d "artifacts/linux-x64" ] || [ "$(ls -A artifacts/linux-x64 | wc -c)" -eq 0 ]; then
            echo "ERROR: backend-publish artifact is missing or empty after download. Ensure publish-backend produced and uploaded it."
            echo "Contents of artifacts directory:"; ls -la artifacts || true
            exit 1
          fi
          echo "Downloaded backend publish contains:"; ls -la artifacts/linux-x64 | sed -n '1,200p'
          if [ ! -x artifacts/linux-x64/HyPrism ]; then
            echo "HyPrism binary not executable; attempting to set executable bit"
            chmod +x artifacts/linux-x64/HyPrism || true
            echo "Post-chmod listing:"; ls -la artifacts/linux-x64 || true
          fi

      - name: Merge frontend into publish
        run: |
          # Fail if frontend artifact wasn't produced
          if [ ! -d "frontend-dist" ] || [ "$(ls -A frontend-dist | wc -c)" -eq 0 ]; then
            echo "ERROR: frontend-dist is missing or empty. Ensure build-frontend produced the artifact."
            ls -la | sed -n '1,200p'
            exit 1
          fi

          # Copy frontend dist into both linux publish outputs
          mkdir -p artifacts/linux-x64/wwwroot
          mkdir -p artifacts/linux-arm64/wwwroot
          cp -R frontend-dist/* artifacts/linux-x64/wwwroot/ || true
          cp -R frontend-dist/* artifacts/linux-arm64/wwwroot/ || true

      - name: Create tar.gz archives
        run: |
          cd artifacts/linux-x64 && tar -czf ../HyPrism-linux-x64.tar.gz . && cd ../..
          cd artifacts/linux-arm64 && tar -czf ../HyPrism-linux-arm64.tar.gz . && cd ../..

      - name: Upload linux publish
        uses: actions/upload-artifact@v4
        with:
          name: linux-publish
          path: |
            artifacts/linux-x64/**
            artifacts/linux-arm64/**
            artifacts/HyPrism-linux-x64.tar.gz
            artifacts/HyPrism-linux-arm64.tar.gz

  package-appimage:
    needs: assemble-linux-publish
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Download linux publish
        uses: actions/download-artifact@v4
        with:
          name: linux-publish
          path: .

      - name: Normalize and verify linux publish artifact ⚠️
        run: |
          set -euo pipefail
          echo "Workspace root listing (partial):"; ls -la | sed -n '1,200p'

          FOUND=""
          if [ -d "artifacts/linux-x64" ] && [ "$(ls -A artifacts/linux-x64 | wc -c)" -gt 0 ]; then
            echo "Found artifacts/linux-x64"
            FOUND="artifacts/linux-x64"
          elif [ -d "linux-x64" ] && [ "$(ls -A linux-x64 | wc -c)" -gt 0 ]; then
            echo "Found linux-x64 at top-level; moving to artifacts/"
            mkdir -p artifacts
            mv linux-x64 artifacts/
            FOUND="artifacts/linux-x64"
          elif [ -f "HyPrism" ]; then
            echo "Found HyPrism at top-level; creating artifacts/linux-x64 and moving files"
            mkdir -p artifacts/linux-x64
            mv HyPrism* artifacts/linux-x64/ || true
            FOUND="artifacts/linux-x64"
          else
            LOC=$(find . -type f -name 'HyPrism' -print -quit || true)
            if [ -n "$LOC" ]; then
              DIR=$(dirname "$LOC")
              echo "Found HyPrism at $LOC; copying $DIR -> artifacts/linux-x64"
              mkdir -p artifacts/linux-x64
              cp -R "$DIR"/* artifacts/linux-x64/
              FOUND="artifacts/linux-x64"
            fi
          fi

          if [ -z "$FOUND" ] || [ ! -d "$FOUND" ] || [ "$(ls -A "$FOUND" | wc -c)" -eq 0 ]; then
            echo "ERROR: linux-publish artifact missing or empty. Ensure assemble-linux-publish succeeded."
            echo "Workspace listing:"; ls -la | sed -n '1,200p'
            exit 1
          fi

          echo "Normalized artifact directory: $FOUND"
          ls -la "$FOUND" | sed -n '1,200p'
          chmod +x "$FOUND"/HyPrism || true

      - name: Install appimagetool
        run: |
          sudo apt-get update
          # Ensure FUSE runtime is available so AppImages can run during checks
          sudo apt-get install -y libfuse2 || true
          curl -fsSL -o /tmp/appimagetool "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
          chmod +x /tmp/appimagetool
          sudo mv /tmp/appimagetool /usr/local/bin/appimagetool

      - name: Create AppImage
        run: |
          mkdir -p AppDir/usr/bin AppDir/usr/lib/hyprism AppDir/usr/share/applications AppDir/usr/share/icons/hicolor/256x256/apps
          cp -R artifacts/linux-x64/* AppDir/usr/lib/hyprism/ || true
          chmod +x AppDir/usr/lib/hyprism/HyPrism || true
          ln -sf ../lib/hyprism/HyPrism AppDir/usr/bin/HyPrism
          cp packaging/flatpak/dev.hyprism.HyPrism.desktop AppDir/usr/share/applications/ || true
          cp packaging/flatpak/dev.hyprism.HyPrism.png AppDir/usr/share/icons/hicolor/256x256/apps/ || true
          cp packaging/flatpak/dev.hyprism.HyPrism.png AppDir/ || true
          cat > AppDir/AppRun << 'EOF'
          #!/bin/sh
          exec "$(dirname "$0")/usr/lib/hyprism/HyPrism" "$@"
          EOF
          chmod +x AppDir/AppRun
          ln -sf usr/share/applications/dev.hyprism.HyPrism.desktop AppDir/HyPrism.desktop || true
          ARCH=x86_64 appimagetool -n AppDir artifacts/HyPrism-linux-x64.AppImage

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: appimage
          path: artifacts/HyPrism-linux-x64.AppImage

  package-flatpak:
    needs: assemble-linux-publish
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Download linux publish
        uses: actions/download-artifact@v4
        with:
          name: linux-publish
          path: .

      - name: Normalize and verify linux publish artifact ⚠️
        run: |
          set -euo pipefail
          echo "Workspace root listing (partial):"; ls -la | sed -n '1,200p'

          FOUND=""
          if [ -d "artifacts/linux-x64" ] && [ "$(ls -A artifacts/linux-x64 | wc -c)" -gt 0 ]; then
            echo "Found artifacts/linux-x64"
            FOUND="artifacts/linux-x64"
          elif [ -d "linux-x64" ] && [ "$(ls -A linux-x64 | wc -c)" -gt 0 ]; then
            echo "Found linux-x64 at top-level; moving to artifacts/"
            mkdir -p artifacts
            mv linux-x64 artifacts/
            FOUND="artifacts/linux-x64"
          elif [ -f "HyPrism" ]; then
            echo "Found HyPrism at top-level; creating artifacts/linux-x64 and moving files"
            mkdir -p artifacts/linux-x64
            mv HyPrism* artifacts/linux-x64/ || true
            FOUND="artifacts/linux-x64"
          else
            LOC=$(find . -type f -name 'HyPrism' -print -quit || true)
            if [ -n "$LOC" ]; then
              DIR=$(dirname "$LOC")
              echo "Found HyPrism at $LOC; copying $DIR -> artifacts/linux-x64"
              mkdir -p artifacts/linux-x64
              cp -R "$DIR"/* artifacts/linux-x64/
              FOUND="artifacts/linux-x64"
            fi
          fi

          if [ -z "$FOUND" ] || [ ! -d "$FOUND" ] || [ "$(ls -A "$FOUND" | wc -c)" -eq 0 ]; then
            echo "ERROR: linux-publish artifact missing or empty. Ensure assemble-linux-publish succeeded."
            echo "Workspace listing:"; ls -la | sed -n '1,200p'
            exit 1
          fi

          echo "Normalized artifact directory: $FOUND"
          ls -la "$FOUND" | sed -n '1,200p'
          chmod +x "$FOUND"/HyPrism || true

      - name: Build Flatpak
        run: |
          set -e
          # Prepare bundle from linux-x64 artifacts (place into packaging/flatpak so manifest sources match)
          rm -rf packaging/flatpak/bundle || true
          mkdir -p packaging/flatpak/bundle
          cp -R artifacts/linux-x64/* packaging/flatpak/bundle/ || true
          cp packaging/flatpak/dev.hyprism.HyPrism.* packaging/flatpak/bundle/ || true
          chmod +x packaging/flatpak/bundle/HyPrism || true

          # Sanity check: ensure HyPrism binary is present and executable
          if [ ! -x packaging/flatpak/bundle/HyPrism ]; then
            echo "ERROR: packaging/flatpak/bundle/HyPrism missing or not executable"
            ls -la packaging/flatpak/bundle || true
            exit 1
          fi

          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder || true

          # Use user-mode remotes to avoid system ConfigureRemote permission errors on runners
          echo "Listing current flatpak remotes (system):"; flatpak remotes || true
          echo "Listing current flatpak remotes (user):"; flatpak --user remotes || true
          flatpak --user remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo || true
          echo "After adding (user) remote:"; flatpak --user remotes || true

          # Try to ensure the required SDK is installed (user scope). If it is missing, attempt install.
          SDK_NAME="org.freedesktop.Sdk"
          SDK_VER="25.08"
          if ! flatpak --user info "$SDK_NAME"//"$SDK_VER" >/dev/null 2>&1; then
            echo "SDK $SDK_NAME/$SDK_VER not found in user scope; attempting user install from flathub (may require network)"
            flatpak --user install -y flathub "$SDK_NAME"//"$SDK_VER" || true
          fi
          echo "Installed user flatpak runtimes:"; flatpak --user list || true

          # Build the Flatpak repo and create a single bundle file (use --user so flatpak-builder doesn't require system permissions)
          flatpak-builder --force-clean --repo=repo --user builddir packaging/flatpak/dev.hyprism.HyPrism.json || true
          flatpak build-bundle repo artifacts/HyPrism.flatpak dev.hyprism.HyPrism || true

      - name: Upload Flatpak artifact
        uses: actions/upload-artifact@v4
        with:
          name: flatpak
          path: artifacts/HyPrism.flatpak

  package-deb-rpm:
    needs: assemble-linux-publish
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Download linux publish
        uses: actions/download-artifact@v4
        with:
          name: linux-publish
          path: .

      - name: Normalize and verify linux publish artifact ⚠️
        run: |
          set -euo pipefail
          echo "Workspace root listing (partial):"; ls -la | sed -n '1,200p'

          FOUND=""
          if [ -d "artifacts/linux-x64" ] && [ "$(ls -A artifacts/linux-x64 | wc -c)" -gt 0 ]; then
            echo "Found artifacts/linux-x64"
            FOUND="artifacts/linux-x64"
          elif [ -d "linux-x64" ] && [ "$(ls -A linux-x64 | wc -c)" -gt 0 ]; then
            echo "Found linux-x64 at top-level; moving to artifacts/"
            mkdir -p artifacts
            mv linux-x64 artifacts/
            FOUND="artifacts/linux-x64"
          elif [ -f "HyPrism" ]; then
            echo "Found HyPrism at top-level; creating artifacts/linux-x64 and moving files"
            mkdir -p artifacts/linux-x64
            mv HyPrism* artifacts/linux-x64/ || true
            FOUND="artifacts/linux-x64"
          else
            LOC=$(find . -type f -name 'HyPrism' -print -quit || true)
            if [ -n "$LOC" ]; then
              DIR=$(dirname "$LOC")
              echo "Found HyPrism at $LOC; copying $DIR -> artifacts/linux-x64"
              mkdir -p artifacts/linux-x64
              cp -R "$DIR"/* artifacts/linux-x64/
              FOUND="artifacts/linux-x64"
            fi
          fi

          if [ -z "$FOUND" ] || [ ! -d "$FOUND" ] || [ "$(ls -A "$FOUND" | wc -c)" -eq 0 ]; then
            echo "ERROR: linux-publish artifact missing or empty. Ensure assemble-linux-publish succeeded."
            echo "Workspace listing:"; ls -la | sed -n '1,200p'
            exit 1
          fi

          echo "Normalized artifact directory: $FOUND"
          ls -la "$FOUND" | sed -n '1,200p'
          chmod +x "$FOUND"/HyPrism || true

      - name: Install packaging tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev build-essential rpm
          sudo gem install --no-document fpm || true

      - name: Create .deb and .rpm
        run: |
          mkdir -p pkg/opt/hyprism pkg/usr/bin pkg/usr/share/applications pkg/usr/share/icons/hicolor/256x256/apps
          cp -R artifacts/linux-x64/* pkg/opt/hyprism/
          chmod +x pkg/opt/hyprism/HyPrism || true
          ln -sf /opt/hyprism/HyPrism pkg/usr/bin/hyprism
          ln -sf /opt/hyprism/HyPrism pkg/usr/bin/HyPrism
          cp packaging/flatpak/dev.hyprism.HyPrism.desktop pkg/usr/share/applications/ || true
          cp packaging/flatpak/dev.hyprism.HyPrism.png pkg/usr/share/icons/hicolor/256x256/apps/ || true
          fpm -s dir -t deb -n hyprism -v ${GITHUB_REF_NAME#v} -C pkg \
            --description "HyPrism - Hytale Launcher" \
            --url "https://github.com/HyPrism/HyPrism" \
            -p artifacts/HyPrism-linux-x64.deb .
          fpm -s dir -t rpm -n hyprism -v ${GITHUB_REF_NAME#v} -C pkg \
            --description "HyPrism - Hytale Launcher" \
            --url "https://github.com/HyPrism/HyPrism" \
            -p artifacts/HyPrism-linux-x64.rpm .

      - name: Upload deb/rpm artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            artifacts/HyPrism-linux-x64.deb
            artifacts/HyPrism-linux-x64.rpm

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Build Windows x64
        run: |
          dotnet restore
          dotnet publish ./HyPrism.csproj -c Release -r win-x64 --self-contained true `
            /p:PublishSingleFile=true /p:PublishReadyToRun=true `
            /p:IncludeNativeLibrariesForSelfExtract=true `
            /p:IncludeAllContentForSelfExtract=true `
            /p:OutputType=WinExe /p:ApplicationManifest=app.manifest `
            /p:ApplicationIcon=packaging/windows/HyPrism.ico `
            -o artifacts/win-x64

      - name: Rename Windows exe for release
        run: |
          # Rename to include version info for direct download
          Copy-Item artifacts/win-x64/HyPrism.exe artifacts/HyPrism-windows-x64.exe

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-builds
          path: artifacts/HyPrism-windows-x64.exe

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Build macOS arm64
        run: |
          dotnet publish ./HyPrism.csproj -c Release -r osx-arm64 --self-contained true \
            -o artifacts/osx-arm64

      - name: Create macOS app bundle (arm64 only)
        run: |
          set -e
          
          mkdir -p "artifacts/HyPrism.app/Contents/MacOS"
          mkdir -p "artifacts/HyPrism.app/Contents/Resources"
          
          if [ ! -f "artifacts/osx-arm64/HyPrism" ]; then
            echo "ERROR: HyPrism binary not found!"
            ls -la artifacts/osx-arm64/ || true
            exit 1
          fi
          
          # Copy ALL files from publish output to MacOS folder (includes all .NET runtime files)
          cp -R artifacts/osx-arm64/* "artifacts/HyPrism.app/Contents/MacOS/"
          
          # Move wwwroot and jre.json to Resources (app expects them in Resources or next to exe)
          if [ -d "artifacts/HyPrism.app/Contents/MacOS/wwwroot" ]; then
            cp -R "artifacts/HyPrism.app/Contents/MacOS/wwwroot" "artifacts/HyPrism.app/Contents/Resources/"
          fi
          if [ -f "artifacts/HyPrism.app/Contents/MacOS/jre.json" ]; then
            cp "artifacts/HyPrism.app/Contents/MacOS/jre.json" "artifacts/HyPrism.app/Contents/Resources/"
          fi
          
          cp packaging/macos/Info.plist "artifacts/HyPrism.app/Contents/"
          cp packaging/macos/HyPrism.icns "artifacts/HyPrism.app/Contents/Resources/"
          chmod +x "artifacts/HyPrism.app/Contents/MacOS/HyPrism"
          echo "APPL????" > "artifacts/HyPrism.app/Contents/PkgInfo"

      - name: Create DMG (arm64 only)
        run: |
          mkdir -p dmg
          cp -R "artifacts/HyPrism.app" "dmg/HyPrism.app"
          ln -s /Applications dmg/Applications
          hdiutil create -volname "HyPrism" -srcfolder dmg -ov -format UDZO artifacts/HyPrism-macos-arm64.dmg

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-builds
          path: artifacts/HyPrism-macos-arm64.dmg

  release:
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.do_release == 'true' }}
    needs: [package-appimage, package-flatpak, package-deb-rpm, build-windows, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      - name: List release assets
        run: ls -la release-assets/

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Determine version from app.manifest (default), optional input override, and tag consistency
        id: determine_version
        run: |
          set -euo pipefail

          # --- Default: derive version from app.manifest (source of truth) ---
          if [ ! -f app.manifest ]; then
            echo "ERROR: app.manifest not found"
            exit 1
          fi
          RAW=$(grep -oP 'assemblyIdentity\s+[^>]*version="\K[^"]+' app.manifest || true)
          if [ -z "$RAW" ]; then
            echo "ERROR: could not parse version from app.manifest"
            exit 1
          fi
          IFS=. read -r MAJOR MINOR PATCH REST <<<"$RAW"
          PATCH=${PATCH:-0}
          VERSION="$MAJOR.$MINOR.$PATCH"

          # --- Optional override by workflow input (discouraged) ---
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "::warning::Version overridden by workflow input (discouraged). Prefer updating app.manifest to keep it authoritative."
            VERSION="${{ github.event.inputs.version }}"
          fi

          # --- If triggered by a tag, ensure consistency with the derived version ---
          if [ -n "${GITHUB_REF_NAME:-}" ]; then
            if [ "${GITHUB_REF_NAME}" != "v$VERSION" ]; then
              echo "ERROR: Tag '${GITHUB_REF_NAME}' does not match version '${VERSION}' (derived from app.manifest or override)."
              echo "Please tag as v$VERSION or provide the correct version via workflow input."
              exit 1
            fi
            TAG_NAME="${GITHUB_REF_NAME}"
          else
            TAG_NAME="v$VERSION"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Create version.json for auto-updater
        run: |
          VERSION="${{ steps.determine_version.outputs.version }}"
          TAG_NAME="${{ steps.determine_version.outputs.tag_name }}"

          cat > release-assets/version.json << EOF
          {
            "version": "$VERSION",
            "linux": {
              "amd64": {
                "launcher": {
                  "url": "https://github.com/$GITHUB_REPOSITORY/releases/download/$TAG_NAME/HyPrism-linux-x64.AppImage",
                  "sha256": ""
                },
                "tarball": {
                  "url": "https://github.com/$GITHUB_REPOSITORY/releases/download/$TAG_NAME/HyPrism-linux-x64.tar.gz",
                  "sha256": ""
                }
              },
              "arm64": {
                "launcher": {
                  "url": "https://github.com/$GITHUB_REPOSITORY/releases/download/$TAG_NAME/HyPrism-linux-arm64.tar.gz",
                  "sha256": ""
                },
                "tarball": {
                  "url": "https://github.com/$GITHUB_REPOSITORY/releases/download/$TAG_NAME/HyPrism-linux-arm64.tar.gz",
                  "sha256": ""
                }
              }
            },
            "windows": {
              "amd64": {
                "launcher": {
                  "url": "https://github.com/$GITHUB_REPOSITORY/releases/download/$TAG_NAME/HyPrism-windows-x64.exe",
                  "sha256": ""
                }
              }
            },
            "darwin": {
              "arm64": {
                "launcher": {
                  "url": "https://github.com/$GITHUB_REPOSITORY/releases/download/$TAG_NAME/HyPrism-macos-arm64.dmg",
                  "sha256": ""
                }
              }
            }
          }
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: HyPrism ${{ github.ref_name }}
          body: |
            ## HyPrism ${{ github.ref_name }}
            
            ### Downloads
            
            **Windows**
            - `HyPrism-windows-x64.zip` - Windows 64-bit
            
            **macOS**
            - `HyPrism-macos-arm64.dmg` - macOS Apple Silicon
            
            **Linux**
            - `HyPrism-linux-x64.tar.gz` - Linux 64-bit portable
            - `HyPrism-linux-arm64.tar.gz` - Linux ARM64 portable
            - `HyPrism-linux-x64.deb` - Debian/Ubuntu package
            - `HyPrism-linux-x64.rpm` - Fedora/RHEL package
            - `HyPrism-linux-x64.AppImage` - Universal Linux AppImage
            
            ### Changes
            - Complete rewrite using .NET 8 and Photino
            - Improved performance and stability
            - Ukrainian language support added
          draft: false
          prerelease: false
          files: |
            release-assets/*
