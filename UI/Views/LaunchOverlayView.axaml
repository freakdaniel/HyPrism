<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:HyPrism.UI.ViewModels"
             xmlns:trans="using:HyPrism.UI.Views.Transitions"
             xmlns:svg="clr-namespace:Avalonia.Svg.Skia;assembly=Avalonia.Svg.Skia"
             xmlns:inputs="using:HyPrism.UI.Components.Inputs"
             mc:Ignorable="d" d:DesignWidth="1280" d:DesignHeight="800"
             x:Class="HyPrism.UI.Views.LaunchOverlayView"
             x:DataType="vm:DashboardViewModel">

    <UserControl.Styles>
        <Style Selector="Button.CancelLaunchButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Template">
                <ControlTemplate>
                    <ContentPresenter Content="{TemplateBinding Content}"
                                      ContentTemplate="{TemplateBinding ContentTemplate}"
                                      HorizontalContentAlignment="{TemplateBinding HorizontalContentAlignment}"
                                      VerticalContentAlignment="{TemplateBinding VerticalContentAlignment}" />
                </ControlTemplate>
            </Setter>
        </Style>
        <Style Selector="TextBlock.CancelLaunchText">
            <Setter Property="Foreground" Value="#888"/>
            <Setter Property="Transitions">
                <Transitions>
                    <BrushTransition Property="Foreground" Duration="0:0:0.2" Easing="CubicEaseOut"/>
                </Transitions>
            </Setter>
        </Style>
        <Style Selector="Button.CancelLaunchButton:pointerover TextBlock.CancelLaunchText">
            <Setter Property="Foreground" Value="#C65A5A"/>
        </Style>
    </UserControl.Styles>
    
    <Grid IsHitTestVisible="{Binding IsLaunchOverlayVisible}" 
          Opacity="{Binding OverlayOpacity}"
          Background="#F2090909">
        <Grid.Transitions>
            <Transitions>
                <DoubleTransition Property="Opacity" Duration="0:0:0.5" Easing="CubicEaseInOut"/>
            </Transitions>
        </Grid.Transitions>

        <Button Command="{Binding CancelLaunchCommand}"
                Classes="CancelLaunchButton"
                HorizontalAlignment="Center"
                VerticalAlignment="Top"
                Margin="0,24,0,0"
                Cursor="Hand">
            <TextBlock Text="{Binding CancelLaunchLabel}"
                       Classes="CancelLaunchText"
                       FontSize="12"
                       HorizontalAlignment="Center"/>
        </Button>
        
        <!-- Content -->
        <Grid>
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="30" Width="700">
                <!-- Animated Icon (changes based on state) -->
                <TransitioningContentControl Content="{Binding ProgressIconPath}">
                    <TransitioningContentControl.PageTransition>
                        <trans:OffsetFadeTransition Duration="0:0:0.3" Offset="20" IsHorizontal="True" />
                    </TransitioningContentControl.PageTransition>
                    <TransitioningContentControl.ContentTemplate>
                        <DataTemplate>
                            <Viewbox Width="80" Height="80" HorizontalAlignment="Center">
                                 <Viewbox.RenderTransform>
                                    <TranslateTransform />
                                </Viewbox.RenderTransform>
                                <svg:Svg Path="{Binding}" Width="80" Height="80">
                                    <svg:Svg.Styles>
                                        <Style Selector="svg|Svg">
                                            <Style.Animations>
                                                <Animation Duration="0:0:2" IterationCount="Infinite" Easing="SineEaseInOut">
                                                    <KeyFrame Cue="0%">
                                                        <Setter Property="TranslateTransform.Y" Value="0"/>
                                                        <Setter Property="Opacity" Value="1"/>
                                                    </KeyFrame>
                                                    <KeyFrame Cue="50%">
                                                        <Setter Property="TranslateTransform.Y" Value="-5"/>
                                                        <Setter Property="Opacity" Value="0.8"/>
                                                    </KeyFrame>
                                                    <KeyFrame Cue="100%">
                                                        <Setter Property="TranslateTransform.Y" Value="0"/>
                                                        <Setter Property="Opacity" Value="1"/>
                                                    </KeyFrame>
                                                </Animation>
                                            </Style.Animations>
                                        </Style>
                                    </svg:Svg.Styles>
                                </svg:Svg>
                            </Viewbox>
                        </DataTemplate>
                    </TransitioningContentControl.ContentTemplate>
                </TransitioningContentControl>
                
                <StackPanel Spacing="10">
                    <!-- Status Title: "Downloading..." or "Patching..." -->
                    <TransitioningContentControl Content="{Binding StatusTitle}">
                        <TransitioningContentControl.PageTransition>
                            <trans:OffsetFadeTransition Duration="0:0:0.3" Offset="30" IsHorizontal="True" />
                        </TransitioningContentControl.PageTransition>
                        <TransitioningContentControl.ContentTemplate>
                            <DataTemplate>
                                 <TextBlock Text="{Binding}" 
                                           Foreground="White" 
                                           FontSize="32" 
                                           FontWeight="Bold"
                                           HorizontalAlignment="Center">
                                    <TextBlock.RenderTransform>
                                        <TranslateTransform />
                                    </TextBlock.RenderTransform>
                                </TextBlock>
                            </DataTemplate>
                        </TransitioningContentControl.ContentTemplate>
                    </TransitioningContentControl>
                </StackPanel>

                <Grid RowDefinitions="Auto, Auto" ColumnDefinitions="*, Auto">
                    <!-- Progress Bar -->
                    <ProgressBar Grid.ColumnSpan="2"
                                 Value="{Binding DownloadProgress}" 
                                 Maximum="100" 
                                 Height="12" 
                                 CornerRadius="6"
                                 Background="#333"
                                 Foreground="#CCC">
                        <ProgressBar.Transitions>
                            <Transitions>
                                <DoubleTransition Property="Value" Duration="0:0:0.4" Easing="CubicEaseOut"/>
                            </Transitions>
                        </ProgressBar.Transitions>
                    </ProgressBar>
                    
                    <!-- Detail Text (Left Aligned, Grey) -->
                    <TextBlock Grid.Row="1" Grid.Column="0"
                               Text="{Binding ProgressText}" 
                               Foreground="#888" 
                               FontSize="14" 
                               Margin="0,8,10,0"
                               HorizontalAlignment="Left"
                               TextTrimming="CharacterEllipsis"/>
                               
                     <!-- Speed (Right Aligned, Grey) -->
                    <TextBlock Grid.Row="1" Grid.Column="1"
                               Text="{Binding CurrentSpeed}" 
                               Foreground="#666" 
                               FontSize="14" 
                               Margin="0,8,0,0"
                               HorizontalAlignment="Right"/>
                </Grid>
            </StackPanel>

            <StackPanel Name="LaunchAfterDownloadPanel"
                        Orientation="Horizontal"
                        Spacing="12"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Bottom"
                        Margin="{Binding IsLaunchAfterDownloadVisible, Converter={StaticResource BoolToLaunchCheckboxMarginConverter}}"
                        Opacity="{Binding IsLaunchAfterDownloadVisible, Converter={StaticResource BoolToOpacityConverter}}"
                        IsHitTestVisible="{Binding IsLaunchAfterDownloadVisible}">
                <StackPanel.Transitions>
                    <Transitions>
                        <DoubleTransition Property="Opacity" Duration="0:0:0.2" Easing="CubicEaseOut"/>
                        <ThicknessTransition Property="Margin" Duration="0:0:0.25" Easing="CubicEaseOut"/>
                    </Transitions>
                </StackPanel.Transitions>

                <inputs:CheckboxInput IsChecked="{Binding LaunchAfterDownload}"/>
                <TextBlock Text="{Binding LaunchAfterDownloadLabel}"
                           Foreground="#CCCCCC"
                           FontSize="14"
                           VerticalAlignment="Center"/>
            </StackPanel>
        </Grid>
    </Grid>
</UserControl>
